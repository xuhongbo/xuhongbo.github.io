<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 设计模式之状态模式 · xuhongbo</title><meta name="description" content="设计模式之状态模式 - xuhongbo"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://xuhongbo.com/atom.xml" title="xuhongbo"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/idea.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">博客</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">文章列表</a></li><li class="nav-list-item"><a href="https://github.com/xuhongbo" target="_blank" class="nav-list-link">GITHUB</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">设计模式之状态模式</h1><div class="post-info">May 22, 2015</div><div class="post-content"><p>状态模式（State）允许一个对象在其内部状态改变的时候改变它的行为，对象看起来似乎修改了它的类。<br><a id="more"></a></p>
<h2 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h2><p>举个例子，就比如我们平时在下载东西，通常就会有好几个状态，比如准备状态（ReadyState）、下载状态（DownloadingState）、暂停状态（DownloadPausedState）、下载完毕状态（DownloadedState）、失败状态（DownloadFailedState），也就是说在每个状态都只可以做当前状态才可以做的事情，而不能做其它状态能做的事儿。</p>
<p>由于 State 模式描述了下载（Download）如何在每一种状态下表现出不同的行为。这一模式的关键思想就是引入了一个叫做 State 的抽象类（或 JS 里的函数）来表示下载状态，State 函数（作为原型）为每个状态的子类（继承函数）声明了一些公共接口。其每个继承函数实现与特定状态相关的行为，比如 DownloadingState 和 DownloadedState 分别实现了正在下载和下载完毕的行为。这些行为可以通过 Download 来来维护。</p>
<p>让我们来实现一把，首先定义作为其他基础函数的原型的 State 函数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">var State = function () &#123;</div><div class="line">&#125;;</div><div class="line">State.prototype.download = function () &#123;</div><div class="line">    throw new Error(&quot;该方法必须被重载!&quot;);</div><div class="line">&#125;;</div><div class="line">State.prototype.pause = function () &#123;</div><div class="line">    throw new Error(&quot;该方法必须被重载!&quot;);</div><div class="line">&#125;;</div><div class="line">State.prototype.fail = function () &#123;</div><div class="line">    throw new Error(&quot;该方法必须被重载!&quot;);</div><div class="line">&#125;;</div><div class="line">State.prototype.finish = function () &#123;</div><div class="line">    throw new Error(&quot;该方法必须被重载!&quot;);</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>我们为 State 的原型定义了 4 个方法接口，分别对应着下载（download）、暂停（pause）、失败（fail）、结束（finish）以便子函数可以重写。</p>
<p>在编写子函数之前，我们先来编写一个 ReadyState 函数，以便可以将状态传递给第一个 download 状态：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">var ReadyState = function (oDownload) &#123;</div><div class="line">    State.apply(this);</div><div class="line">    this.oDownload = oDownload;</div><div class="line">&#125;;</div><div class="line">ReadyState.prototype = new State();</div><div class="line">ReadyState.prototype.download = function () &#123;</div><div class="line">    this.oDownload.setState(this.oDownload.getDownloadingState());</div><div class="line">    // Ready以后，可以开始下载，所以设置了Download函数里的状态获取方法</div><div class="line"> console.log(&quot;Start Download!&quot;);</div><div class="line">&#125;;</div><div class="line">ReadyState.prototype.pause = function () &#123;</div><div class="line">    throw new Error(&quot;还没开始下载，不能暂停!&quot;);</div><div class="line">&#125;;</div><div class="line">ReadyState.prototype.fail = function () &#123;</div><div class="line">    throw new Error(&quot;文件还没开始下载，怎么能说失败呢!&quot;);</div><div class="line">&#125;;</div><div class="line">ReadyState.prototype.finish = function () &#123;</div><div class="line">    throw new Error(&quot;文件还没开始下载，当然也不能结束了!&quot;);</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>该函数接收了一个 Download 维护函数的实例作为参数，Download 函数用于控制状态的改变和获取（类似于中央控制器，让外部调用），ReadyState 重写了原型的 download 方法，以便开始进行下载。我们继续来看 Download 函数的主要功能：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">var Download = function () &#123;</div><div class="line">    this.oState = new ReadyState(this);</div><div class="line">&#125;;</div><div class="line">Download.prototype.setState = function (oState) &#123;</div><div class="line">    this.oState = oState;</div><div class="line">&#125;;</div><div class="line">// 对外暴露的四个公共方法，以便外部调用</div><div class="line">Download.prototype.download = function () &#123;</div><div class="line">    this.oState.download();</div><div class="line">&#125;;</div><div class="line">Download.prototype.pause = function () &#123;</div><div class="line">    this.oState.pause();</div><div class="line">&#125;;</div><div class="line">Download.prototype.fail = function () &#123;</div><div class="line">    this.oState.fail();</div><div class="line">&#125;;</div><div class="line">Download.prototype.finish = function () &#123;</div><div class="line">    this.oState.finish();</div><div class="line">&#125;;</div><div class="line">//获取各种状态，传入当前this对象</div><div class="line">Download.prototype.getReadyState = function () &#123;</div><div class="line">    return new ReadyState(this);</div><div class="line">&#125;;</div><div class="line">Download.prototype.getDownloadingState = function () &#123;</div><div class="line">    return new DownloadingState(this);</div><div class="line">&#125;;</div><div class="line">Download.prototype.getDownloadPausedState = function () &#123;</div><div class="line">    return new DownloadPausedState(this);</div><div class="line">&#125;;</div><div class="line">Download.prototype.getDownloadedState = function () &#123;</div><div class="line">    return new DownloadedState(this);</div><div class="line">&#125;;</div><div class="line">Download.prototype.getDownloadedFailedState = function () &#123;</div><div class="line">    return new DownloadFailedState(this);</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>Download 函数的原型提供了 8 个方法，4 个是对用于下载状态的操作行为，另外 4 个是用于获取当前四个不同的状态，这 4 个方法都接收 this 作为参数，也就是将 Download 实例自身作为一个参数传递给处理该请求的状态对象（ReadyState 以及后面要实现的继承函数），这使得状态对象比必要的时候可以访问 oDownlaod。</p>
<p>接下来，继续定义 4 个相关状态的函数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">var DownloadingState = function (oDownload) &#123;</div><div class="line">    State.apply(this);</div><div class="line">    this.oDownload = oDownload;</div><div class="line">&#125;;</div><div class="line">DownloadingState.prototype = new State();</div><div class="line">DownloadingState.prototype.download = function () &#123;</div><div class="line">    throw new Error(&quot;文件已经正在下载中了!&quot;);</div><div class="line">&#125;;</div><div class="line">DownloadingState.prototype.pause = function () &#123; this.oDownload.setState(this.oDownload.getDownloadPausedState());</div><div class="line">    console.log(&quot;暂停下载!&quot;);</div><div class="line">&#125;;</div><div class="line">DownloadingState.prototype.fail = function () &#123; this.oDownload.setState(this.oDownload.getDownloadedFailedState());</div><div class="line">    console.log(&quot;下载失败!&quot;);</div><div class="line">&#125;;</div><div class="line">DownloadingState.prototype.finish = function () &#123;</div><div class="line">    this.oDownload.setState(this.oDownload.getDownloadedState());</div><div class="line">    console.log(&quot;下载完毕!&quot;);</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>DownloadingState 的主要注意事项就是已经正在下载的文件，不能再次开始下载了，其它的状态都可以连续进行。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line">var DownloadPausedState = function (oDownload) &#123;</div><div class="line">    State.apply(this);</div><div class="line">    this.oDownload = oDownload;</div><div class="line">&#125;;</div><div class="line">DownloadPausedState.prototype = new State();</div><div class="line">DownloadPausedState.prototype.download = function () &#123;</div><div class="line">    this.oDownload.setState(this.oDownload.getDownloadingState());</div><div class="line">    console.log(&quot;继续下载!&quot;);</div><div class="line">&#125;;</div><div class="line">DownloadPausedState.prototype.pause = function () &#123;</div><div class="line">    throw new Error(&quot;已经暂停了，咋还要暂停呢!&quot;);</div><div class="line">&#125;;</div><div class="line">DownloadPausedState.prototype.fail = function () &#123; this.oDownload.setState(this.oDownload.getDownloadedFailedState());</div><div class="line">    console.log(&quot;下载失败!&quot;);</div><div class="line">&#125;;</div><div class="line">DownloadPausedState.prototype.finish = function () &#123;</div><div class="line">    this.oDownload.setState(this.oDownload.getDownloadedState());</div><div class="line">    console.log(&quot;下载完毕!&quot;);</div><div class="line">&#125;;</div><div class="line">DownloadPausedState函数里要注意的是，已经暂停的下载，不能再次暂停。</div><div class="line">var DownloadedState = function (oDownload) &#123;</div><div class="line">    State.apply(this);</div><div class="line">    this.oDownload = oDownload;</div><div class="line">&#125;;</div><div class="line">DownloadedState.prototype = new State();</div><div class="line">DownloadedState.prototype.download = function () &#123;</div><div class="line">    this.oDownload.setState(this.oDownload.getDownloadingState());</div><div class="line">    console.log(&quot;重新下载!&quot;);</div><div class="line">&#125;;</div><div class="line">DownloadedState.prototype.pause = function () &#123;</div><div class="line">    throw new Error(&quot;对下载完了，还暂停啥？&quot;);</div><div class="line">&#125;;</div><div class="line">DownloadedState.prototype.fail = function () &#123;</div><div class="line">    throw new Error(&quot;都下载成功了，咋会失败呢？&quot;);</div><div class="line">&#125;;</div><div class="line">DownloadedState.prototype.finish = function () &#123;</div><div class="line">    throw new Error(&quot;下载成功了，不能再为成功了吧!&quot;);</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>DownloadedState 函数，同理成功下载以后，不能再设置 finish 了，只能设置重新下载状态。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">var DownloadFailedState = function (oDownload) &#123;</div><div class="line">    State.apply(this);</div><div class="line">    this.oDownload = oDownload;</div><div class="line">&#125;;</div><div class="line">DownloadFailedState.prototype = new State();</div><div class="line">DownloadFailedState.prototype.download = function () &#123;</div><div class="line">    this.oDownload.setState(this.oDownload.getDownloadingState());</div><div class="line">    console.log(&quot;尝试重新下载!&quot;);</div><div class="line">&#125;;</div><div class="line">DownloadFailedState.prototype.pause = function () &#123;</div><div class="line">    throw new Error(&quot;失败的下载，也不能暂停!&quot;);</div><div class="line">&#125;;</div><div class="line">DownloadFailedState.prototype.fail = function () &#123;</div><div class="line">    throw new Error(&quot;都失败了，咋还失败呢!&quot;);</div><div class="line">&#125;;</div><div class="line">DownloadFailedState.prototype.finish = function () &#123;</div><div class="line">    throw new Error(&quot;失败的下载，肯定也不会成功!&quot;);</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>同理，DownloadFailedState 函数的失败状态，也不能再次失败，但可以和 finished 以后再次尝试重新下载。</p>
<p>调用测试代码，就非常简单了，我们在 HTML 里演示吧，首先是要了 jquery，然后有 3 个按钮分别代表：开始下载、暂停、重新下载。（注意在 Firefox 里用 firebug 查看结果，因为用了 console.log 方法）。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">&lt;html&gt;</div><div class="line">&lt;head&gt;</div><div class="line">    &lt;link type=&quot;text/css&quot; rel=&quot;stylesheet&quot; href=&quot;http://www.cnblogs.com/css/style.css&quot; /&gt;</div><div class="line">    &lt;title&gt;State Pattern&lt;/title&gt;</div><div class="line">    &lt;script type=&quot;text/javascript&quot; src=&quot;/jquery.js&quot;&gt;&lt;/script&gt;</div><div class="line">    &lt;script type=&quot;text/javascript&quot; src=&quot;Download.js&quot;&gt;&lt;/script&gt;</div><div class="line">    &lt;script type=&quot;text/javascript&quot; src=&quot;states/State.js&quot;&gt;&lt;/script&gt;</div><div class="line">    &lt;script type=&quot;text/javascript&quot; src=&quot;states/DownloadFailedState.js&quot;&gt;&lt;/script&gt;</div><div class="line">    &lt;script type=&quot;text/javascript&quot; src=&quot;states/DownloadPausedState.js&quot;&gt;&lt;/script&gt;</div><div class="line">    &lt;script type=&quot;text/javascript&quot; src=&quot;states/DownloadedState.js&quot;&gt;&lt;/script&gt;</div><div class="line">    &lt;script type=&quot;text/javascript&quot; src=&quot;states/DownloadingState.js&quot;&gt;&lt;/script&gt;</div><div class="line">    &lt;script type=&quot;text/javascript&quot; src=&quot;states/ReadyState.js&quot;&gt;&lt;/script&gt;</div><div class="line">&lt;/head&gt;</div><div class="line">&lt;body&gt;</div><div class="line">    &lt;input type=&quot;button&quot; value=&quot;开始下载&quot; id=&quot;download_button&quot; /&gt;</div><div class="line">    &lt;input type=&quot;button&quot; value=&quot;暂停&quot; id=&quot;pause_button&quot; /&gt;</div><div class="line">    &lt;input type=&quot;button&quot; value=&quot;重新下载&quot; id=&quot;resume_button&quot; /&gt;</div><div class="line">    &lt;script type=&quot;text/javascript&quot;&gt;</div><div class="line">        var oDownload = new Download();</div><div class="line">        $(&quot;#download_button&quot;).click(function () &#123;</div><div class="line">            oDownload.download();</div><div class="line">        &#125;);</div><div class="line">        $(&quot;#pause_button&quot;).click(function () &#123;</div><div class="line">            oDownload.pause();</div><div class="line">        &#125;);</div><div class="line">        $(&quot;#resume_button&quot;).click(function () &#123;</div><div class="line">            oDownload.download();</div><div class="line">        &#125;);</div><div class="line">    &lt;/script&gt;</div><div class="line">&lt;/body&gt;</div><div class="line">&lt;/html&gt;</div></pre></td></tr></table></figure>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>状态模式的使用场景也特别明确，有如下两点：</p>
<ol>
<li>一个对象的行为取决于它的状态，并且它必须在运行时刻根据状态改变它的行为。</li>
<li>一个操作中含有大量的分支语句，而且这些分支语句依赖于该对象的状态。状态通常为一个或多个枚举常量的表示。</li>
</ol>
</div></article></div></main><footer><div class="paginator"><a href="/2015/07/23/深入理解javascript/33设计模式之策略模式/" class="prev">PREV</a><a href="/2015/05/16/深入理解javascript/38设计模式之职责链模式/" class="next">NEXT</a></div><div class="copyright"><p>© 2014 - 2017 <a href="https://github.com/xuhongbo" target="_blank">xuhongbo-github</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>